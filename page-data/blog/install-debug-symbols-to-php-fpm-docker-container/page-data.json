{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/install-debug-symbols-to-php-fpm-docker-container","result":{"data":{"markdownRemark":{"html":"<p>Container images don't include debug symbols,\nperhaps it is more important to reduce size of the images.</p>\n<p>Unlike Debian that has all the <package>-dbg' packages\n(alternatively, it is possible to get <package>-dbgsym),\nDocker image vendors virtually never provide separate versions\nwith debug symbols enabled. Wordpress official images are\nnot exceptions.</p>\n<p>I can think of the following reasons why the vendors\nof the Docker container images don't consider\ninteractive debugging as a must-have feature anymore:</p>\n<ul>\n<li>Debug symbols increase the image size;</li>\n<li>The code runs in the cloud, that means does not matter where it\nis actually running, so it is not clear how we can attach the\ndebugger;</li>\n<li>Advanced paradigms, like async and coroutines make imperative\nstepping through instructions a technique that gives good\ninsight of the runtime state.</li>\n<li>Similarly, the machine code may be optimized in a sophisticated\nway, so that throttling it to human speed would make it impossible\nto reproduce bugs anyway.</li>\n</ul>\n<p>However PHP is quite old and primitive, therefore it can still\nbe the best to debug it with the good old GDB.</p>\n<p>Here, I will try to log, step-by-step what was required to do,\nin order to rebuild the image to include the debugging symbols at\nthe same time reusing as much as possible from the original image,\nand not rebuilding everything from scratch.</p>\n<h2>Assess the situation</h2>\n<p>First we will double check that the debug symbols are not there originally:</p>\n<pre><code>root@63a355210d9b:/src# file /usr/local/sbin/php-fpm\n/usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=3a1b578d90a949925775c0827920ff4205ee16e3, stripped\n</code></pre>\n<p>That \"stripped\" means that the binary does not include the debugging data.\n(also this can be checked using the 'objdump --syms')</p>\n<p>So debug symbols are not installed!</p>\n<p>As the image is Debian based, we can check if the php is installed as a package,\nas that would allow us just to install additional php-fpm-dbg package:</p>\n<pre><code>root@63a355210d9b:/src# dpkg -S $(which php-fpm) \ndpkg-query: no path found matching pattern /usr/local/sbin/php-fpm\n</code></pre>\n<p>looks like no, also:</p>\n<pre><code>apt-file find $(which php-fpm)\n</code></pre>\n<p>does not print anything.</p>\n<p>So it is clear that PHP is not installed from the APT package.</p>\n<p>Nevertheless, checking the history, shows that indeed the message includes\nPHP compiled from sources:</p>\n<pre><code>docker history --no-trunc --format '{{.CreatedBy }}' wordpress:fpm\n...\n    /bin/sh -c set -xe  &#x26;&#x26; buildDeps=\"   $PHP_EXTRA_BUILD_DEPS   libargon2-0-dev   libcurl4-openssl-dev   libedit-dev   libsqlite3-dev   libssl-dev   libxml2-dev   zlib1g-dev  \"  &#x26;&#x26; apt-get update &#x26;&#x26; apt-get install -y $buildDeps --no-install-recommends &#x26;&#x26; rm -rf /var/lib/apt/lists/*   &#x26;&#x26; export CFLAGS=\"$PHP_CFLAGS\"   CPPFLAGS=\"$PHP_CPPFLAGS\"   LDFLAGS=\"$PHP_LDFLAGS\"  &#x26;&#x26; docker-php-source extract  &#x26;&#x26; cd /usr/src/php  &#x26;&#x26; gnuArch=\"$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)\"  &#x26;&#x26; debMultiarch=\"$(dpkg-architecture --query DEB_BUILD_MULTIARCH)\"  &#x26;&#x26; if [ ! -d /usr/include/curl ]; then   ln -sT \"/usr/include/$debMultiarch/curl\" /usr/local/include/curl;  fi  &#x26;&#x26; ./configure   --build=\"$gnuArch\"   --with-config-file-path=\"$PHP_INI_DIR\"   --with-config-file-scan-dir=\"$PHP_INI_DIR/conf.d\"     --disable-cgi     --enable-ftp   --enable-mbstring   --enable-mysqlnd   --with-password-argon2     --with-curl   --with-libedit   --with-openssl   --with-zlib     $(test \"$gnuArch\" = 's390x-linux-gnu' &#x26;&#x26; echo '--without-pcre-jit')   --with-libdir=\"lib/$debMultiarch\"     $PHP_EXTRA_CONFIGURE_ARGS  &#x26;&#x26; make -j \"$(nproc)\"  &#x26;&#x26; make install  &#x26;&#x26; { find /usr/local/bin /usr/local/sbin -type f -executable -exec strip --strip-all '{}' + || true; }  &#x26;&#x26; make clean  &#x26;&#x26; cd /  &#x26;&#x26; docker-php-source delete   &#x26;&#x26; apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false $buildDeps   &#x26;&#x26; pecl update-channels  &#x26;&#x26; rm -rf /tmp/pear ~/.pearrc\n...\n</code></pre>\n<p>So we will need to find the <a href=\"https://github.com/docker-library/php/blob/6677546d599d3980781b520f84d03ecaad291dd1/7.2/stretch/fpm/Dockerfile#L104-L166\">original Dockerfile</a>,\nto see what command needs to be re-run for our custom image to include the symbols.</p>\n<p>We will have to put <a href=\"https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L45-L46\">our Dockerfile</a>,\nthat recompiles the PHP with <code>--enable-debug</code> flag set.</p>\n<p>After the installation we need to rebuild plugins required for the Wordpress with <a href=\"https://github.com/normantas/enchanted-lamp/blob/master/docker/wordpress/Dockerfile#L61-L69\">docker-php-ext-install</a>.</p>\n<p>And that is it! After rebuilding this image one should see:</p>\n<pre><code>file /usr/local/sbin/php-fpm\n/usr/local/sbin/php-fpm: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=4f0f0802b93f011a3d1faa92be7e2c0d8646f78a, not stripped\n</code></pre>\n<p>Meaning that our image now can be debugged with GDB!</p>","frontmatter":{"date":"June 18, 2018","slug":"/blog/install-debug-symbols-to-php-fpm-docker-container","title":"Install debug symbols to fpm Docker container"}}},"pageContext":{"slug":"/blog/install-debug-symbols-to-php-fpm-docker-container"}},"staticQueryHashes":["3649515864","63159454"]}